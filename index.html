<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Household Survey Dashboard - Palakoderu</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- DataTables CSS (with Bootstrap styling) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
    
    <!-- Leaflet MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #map { height: 500px; border-radius: 12px; overflow: hidden; }
        .table-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { font-weight: 700; color: #2c3e50; }
        .stat-card h3 { font-size: 2.5rem; font-weight: bold; }
        .stat-card .text-muted { font-size: 1.1rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Household Survey Dashboard</h1>
        <p class="text-center text-muted mb-5">Palakoderu Village, West Godavari District, Andhra Pradesh</p>

        <!-- Dashboard Cards -->
        <div class="row mb-4 g-4">
            <div class="col-md-3 col-6">
                <div class="card stat-card text-center p-4 bg-primary text-white">
                    <h3 id="total">0</h3>
                    <p class="text-white-50 mb-0">Total Households</p>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card stat-card text-center p-4 bg-success text-white">
                    <h3 id="completed">0</h3>
                    <p class="text-white-50 mb-0">Surveys Completed</p>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card stat-card text-center p-4 bg-warning text-white">
                    <h3 id="notcompleted">0</h3>
                    <p class="text-white-50 mb-0">Not Completed</p>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card stat-card text-center p-4 bg-info text-white">
                    <h3 id="withgps">0</h3>
                    <p class="text-white-50 mb-0">With GPS Location</p>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div class="card mb-4">
            <div class="card-body p-0">
                <div id="map"></div>
            </div>
            <div class="card-footer text-muted small">
                Click on markers/clusters to view household details
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-container mb-5">
            <h3 class="mb-4">Household Data Table</h3>
            <table id="dataTable" class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Household ID</th>
                        <th>Name</th>
                        <th>Address</th>
                        <th>Mobile</th>
                        <th>Age</th>
                        <th>Survey Status</th>
                        <th>Cluster ID</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // Updated reliable proxy
        const originalCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSIkAQDImTQezGnyH3mlW1svR4HOym0q31In7WwAdNow-Zyho0jQ1cyFQ4VwGZXdM29S6J15O5jKAaJ/pub?output=csv';
        const csvUrl = 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(originalCsvUrl);

        let map, markerCluster;

        function initMap() {
            map = L.map('map').setView([16.55, 81.59], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            markerCluster = L.markerClusterGroup();
            map.addLayer(markerCluster);
        }

        $(document).ready(function() {
            initMap();

            Papa.parse(csvUrl, {
                download: true,
                header: true,
                complete: function(results) {
                    const data = results.data.filter(row => row.HOUSEHOLDID); // Remove empty rows

                    // Update dashboard stats
                    const total = data.length;
                    const completed = data.filter(r => r.SURVEY_STATUS && r.SURVEY_STATUS.trim() === 'Completed').length;
                    const notCompleted = total - completed;
                    const withGps = data.filter(r => {
                        const lat = parseFloat(r.HH_LATITUDE);
                        const lon = parseFloat(r.HH_LONGITUDE);
                        return !isNaN(lat) && !isNaN(lon) && lat !== 0 && lon !== 0;
                    }).length;

                    $('#total').text(total);
                    $('#completed').text(completed);
                    $('#notcompleted').text(notCompleted);
                    $('#withgps').text(withGps);

                    // Add markers
                    data.forEach(row => {
                        const lat = parseFloat(row.HH_LATITUDE);
                        const lon = parseFloat(row.HH_LONGITUDE);
                        if (!isNaN(lat) && !isNaN(lon) && lat !== 0 && lon !== 0) {
                            const statusColor = (row.SURVEY_STATUS && row.SURVEY_STATUS.trim() === 'Completed') ? 'green' : 'red';
                            const popup = `
                                <div class="p-2">
                                    <b>Name:</b> ${row.CITIZEN_NAME || 'N/A'}<br>
                                    <b>Address:</b> ${row.ADDRESS || 'N/A'}<br>
                                    <b>Mobile:</b> ${row.MOBILE_NUMBER || 'N/A'}<br>
                                    <b>Age:</b> \( {row.AGE_IN_YEARS || 'N/A'} ( \){row.AGE_FLAG || ''})<br>
                                    <b><span style="color:${statusColor};font-weight:bold;">Status:</span></b> ${row.SURVEY_STATUS || 'N/A'}
                                </div>`;
                            const marker = L.marker([lat, lon]).bindPopup(popup);
                            markerCluster.addLayer(marker);
                        }
                    });

                    if (withGps > 0) map.fitBounds(markerCluster.getBounds(), { padding: [50, 50] });

                    // Initialize DataTable
                    $('#dataTable').DataTable({
                        data: data,
                        pageLength: 15,
                        responsive: true,
                        columns: [
                            { data: 'HOUSEHOLDID' },
                            { data: 'CITIZEN_NAME' },
                            { data: 'ADDRESS' },
                            { data: 'MOBILE_NUMBER' },
                            { data: 'AGE_IN_YEARS' },
                            { data: 'SURVEY_STATUS' },
                            { data: 'CLUSTER_ID' }
                        ],
                        order: [[0, 'asc']]
                    });
                },
                error: function(err) {
                    alert('Still failed to load data. Check your internet or try opening the file via a local web server (recommended for reliability).');
                    console.error(err);
                }
            });
        });
    </script>
</body>
</html>
