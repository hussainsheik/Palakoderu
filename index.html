<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palakoderu Household Survey ‚Ä¢ Premium Dashboard</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <!-- DataTables with custom styling -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #e0e0e0;
            min-height: 100vh;
            margin: 0;
            padding-bottom: 80px;
        }
        .header-gradient {
            background: linear-gradient(120deg, #00b4db, #0083b0);
            padding: 70px 20px;
            text-align: center;
            border-radius: 0 0 40px 40px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
            animation: gradientShift 18s ease infinite;
            background-size: 400% 400%;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        h1 { font-weight: 700; color: white; text-shadow: 0 5px 15px rgba(0,0,0,0.4); font-size: 2.8rem; }
        .subtitle { font-size: 1.3rem; color: rgba(255,255,255,0.95); }

        .stat-card {
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(12px);
            border-radius: 22px;
            border: 1px solid rgba(255,255,255,0.18);
            transition: all 0.5s ease;
            overflow: hidden;
        }
        .stat-card:hover {
            transform: translateY(-12px) scale(1.03);
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
        }
        .stat-number {
            font-size: 3.2rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        #map {
            height: 620px;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.1);
        }

        .table-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            border-radius: 24px;
            padding: 35px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.15);
            margin-top: 50px;
        }

        /* Beautiful DataTable Styling */
        .dataTables_wrapper .dataTables_length select,
        .dataTables_wrapper .dataTables_filter input {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            color: white;
            padding: 8px 15px;
        }
        .dataTables_wrapper .dataTables_filter input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        table.dataTable {
            color: #f0f0f0;
        }
        table.dataTable thead th {
            background: rgba(0,0,0,0.3);
            color: #00ffb8;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }
        table.dataTable tbody tr {
            background: rgba(255,255,255,0.05);
            transition: all 0.3s ease;
        }
        table.dataTable tbody tr:hover {
            background: rgba(0, 180, 219, 0.25) !important;
            transform: scale(1.01);
            box-shadow: 0 8px 20px rgba(0, 180, 219, 0.3);
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            background: rgba(255,255,255,0.1) !important;
            border: none !important;
            color: white !important;
            border-radius: 10px !important;
            margin: 0 4px;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #00b4db !important;
            color: white !important;
        }

        .loading-spinner {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .fade-in {
            opacity: 0;
            animation: fadeIn 1.2s ease forwards;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
    </style>
</head>
<body>

<div class="loading-spinner">
    <div class="spinner-border text-info" style="width: 5rem; height: 5rem;" role="status"></div>
    <p class="mt-4 fs-3 text-white">Crafting your beautiful dashboard...</p>
</div>

<div class="header-gradient">
    <h1>Palakoderu Household Survey</h1>
    <p class="subtitle">West Godavari District ‚Ä¢ Andhra Pradesh ‚Ä¢ Real-time Monitoring</p>
</div>

<div class="container my-5 fade-in">
    <div class="row g-5 mb-5">
        <div class="col-lg-3 col-md-6">
            <div class="stat-card text-center p-5 text-primary">
                <div class="stat-number" id="total">0</div>
                <p class="fs-5 mb-0">Total Households</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card text-center p-5 text-success">
                <div class="stat-number" id="completed">0</div>
                <p class="fs-5 mb-0">Surveys Completed</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card text-center p-5 text-warning">
                <div class="stat-number" id="notcompleted">0</div>
                <p class="fs-5 mb-0">Not Completed</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card text-center p-5 text-info">
                <div class="stat-number" id="withgps">0</div>
                <p class="fs-5 mb-0">With GPS Location</p>
            </div>
        </div>
    </div>

    <div class="mb-5 fade-in">
        <div id="map"></div>
        <div class="text-center mt-4 text-muted small">
            üåç Click clusters/markers ‚Ä¢ Green = Completed ‚Ä¢ Red = Not Completed ‚Ä¢ Coordinates shown in popup
        </div>
    </div>

    <div class="table-container fade-in">
        <h3 class="text-center mb-5 text-white" style="font-size: 2rem; font-weight: 600;">
            Household Details Table
        </h3>
        <table id="dataTable" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Mobile</th>
                    <th>Age</th>
                    <th>Latitude</th>
                    <th>Longitude</th>
                    <th>Status</th>
                    <th>Cluster ID</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    const originalUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSIkAQDImTQezGnyH3mlW1svR4HOym0q31In7WwAdNow-Zyho0jQ1cyFQ4VwGZXdM29S6J15O5jKAaJ/pub?output=csv';
    const csvUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(originalUrl);

    let map, markerCluster;

    function initMap() {
        map = L.map('map').setView([16.55, 81.59], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        markerCluster = L.markerClusterGroup({
            maxClusterRadius: 50,
            iconCreateFunction: function(cluster) {
                return L.divIcon({
                    html: `<div style="background:#00b4db;color:white;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-weight:bold;box-shadow:0 4px 15px rgba(0,0,0,0.4);">${cluster.getChildCount()}</div>`,
                    className: '',
                    iconSize: [40, 40]
                });
            }
        });
        map.addLayer(markerCluster);
    }

    function animateCount(element, target) {
        let count = 0;
        const increment = target / 60;
        const timer = setInterval(() => {
            count += increment;
            if (count >= target) {
                element.textContent = target.toLocaleString();
                clearInterval(timer);
            } else {
                element.textContent = Math.floor(count).toLocaleString();
            }
        }, 30);
    }

    $(document).ready(function() {
        initMap();

        Papa.parse(csvUrl, {
            download: true,
            header: true,
            complete: function(results) {
                $('.loading-spinner').fadeOut(800);
                $('.fade-in').each(function(i) {
                    $(this).delay(i * 400).queue(function() { $(this).css('opacity', 1); $(this).dequeue(); });
                });

                const data = results.data.filter(row => row.HOUSEHOLDID);

                const total = data.length;
                const completed = data.filter(r => r.SURVEY_STATUS?.trim() === 'Completed').length;
                const notCompleted = total - completed;
                const withGps = data.filter(r => {
                    const lat = parseFloat(r.HH_LATITUDE);
                    const lon = parseFloat(r.HH_LONGITUDE);
                    return !isNaN(lat) && !isNaN(lon) && lat !== 0 && lon !== 0;
                }).length;

                animateCount(document.getElementById('total'), total);
                animateCount(document.getElementById('completed'), completed);
                animateCount(document.getElementById('notcompleted'), notCompleted);
                animateCount(document.getElementById('withgps'), withGps);

                const greenIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                    iconSize: [25,41], iconAnchor: [12,41]
                });
                const redIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                    iconSize: [25,41], iconAnchor: [12,41]
                });

                data.forEach(row => {
                    const lat = parseFloat(row.HH_LATITUDE);
                    const lon = parseFloat(row.HH_LONGITUDE);
                    if (!isNaN(lat) && !isNaN(lon) && lat !== 0 && lon !== 0) {
                        const isCompleted = row.SURVEY_STATUS?.trim() === 'Completed';
                        const icon = isCompleted ? greenIcon : redIcon;

                        const popup = `
                            <div style="font-family:Poppins,sans-serif; min-width:240px; padding:8px;">
                                <h6 style="color:#00b4db; margin-bottom:10px; text-align:center;">Household Details</h6>
                                <b>Name:</b> ${row.CITIZEN_NAME || 'N/A'}<br>
                                <b>Address:</b> ${row.ADDRESS || 'N/A'}<br>
                                <b>Mobile:</b> ${row.MOBILE_NUMBER || 'N/A'}<br>
                                <b>Age:</b> \( {row.AGE_IN_YEARS || 'N/A'} ( \){row.AGE_FLAG || ''})<br>
                                <hr style="border-color:rgba(255,255,255,0.2); margin:8px 0;">
                                <b>üìç Coordinates:</b><br>
                                <b>&nbsp;&nbsp;Latitude:</b> ${lat.toFixed(6)}<br>
                                <b>&nbsp;&nbsp;Longitude:</b> ${lon.toFixed(6)}<br>
                                <hr style="border-color:rgba(255,255,255,0.2); margin:8px 0;">
                                <b style="color:${isCompleted ? '#28a745' : '#dc3545'}; font-weight:bold;">Status:</b> ${row.SURVEY_STATUS || 'N/A'}
                            </div>`;

                        L.marker([lat, lon], { icon }).bindPopup(popup).addTo(markerCluster);
                    }
                });

                if (withGps > 0) map.fitBounds(markerCluster.getBounds(), { padding: [60, 60] });

                // Beautiful DataTable with coordinates
                $('#dataTable').DataTable({
                    data: data,
                    pageLength: 20,
                    responsive: true,
                    lengthMenu: [10, 20, 50, 100],
                    order: [[0, 'asc']],
                    columns: [
                        { data: 'HOUSEHOLDID' },
                        { data: 'CITIZEN_NAME' },
                        { data: 'ADDRESS' },
                        { data: 'MOBILE_NUMBER' },
                        { data: 'AGE_IN_YEARS' },
                        { data: 'HH_LATITUDE', render: data => data ? parseFloat(data).toFixed(6) : 'N/A' },
                        { data: 'HH_LONGITUDE', render: data => data ? parseFloat(data).toFixed(6) : 'N/A' },
                        { data: 'SURVEY_STATUS', render: data => {
                            if (!data) return '<span class="badge bg-secondary">Unknown</span>';
                            return data.trim() === 'Completed' 
                                ? '<span class="badge bg-success">Completed</span>'
                                : '<span class="badge bg-danger">Not Completed</span>';
                        }},
                        { data: 'CLUSTER_ID' }
                    ]
                });
            },
            error: function(err) {
                $('.loading-spinner').html('<div class="text-center"><p class="text-danger fs-3">Failed to load data</p><p class="text-white">Check internet connection and refresh</p></div>');
                console.error(err);
            }
        });
    });
</script>
</body>
</html>
